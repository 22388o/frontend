<div class="card asset-card col-12 hover-shadow"
  [ngClass]="{'border border-primary' : +info.rewardInfos[vault.assetToken]?.bond_amount}">
  <div class="card-body">
    <span *ngIf="+info.rewardInfos[vault.assetToken]?.bond_amount"
      class="badge bg-primary position-absolute badge-deposited">Deposited</span>
    <span *ngIf="info.tokenBalances[vault.assetToken]!=='0'"
      class="badge bg-info position-absolute badge-depositable">Depositable</span>
    <div class="row asset-card-info" (click)="belowSection.toggle()" aria-expanded="false" aria-controls="belowSection">
      <div class="col-12 col-md-3 text-center">
        <div class="p-2">
          <img [src]="vault.symbol | url:'icon'" class="img-fluid rounded-circle mAssetIcon">
          <img [src]="'UST' | url:'icon'" class="img-fluid rounded-circle mAssetIcon ust-outline">
        </div>
        <div class="fs-5">
          {{vault.symbol}}-UST LP
        </div>
        <div class="fs-6">
          Farm: {{vault.poolInfo.farm}}
        </div>
      </div>
      <div class="col-12 col-md-9">
        <div class="row">
          <div class="col-12 col-sm-12 col-md-4">
            <div class="fs-6 mt-2">APY</div>
            <div class="fs-5">
              <span *ngIf="vault.apy > vault.pairStat?.farmApr">
                <span class="text-primary text-decoration-line-through">
                  <span class="text-muted">{{ vault.pairStat?.poolApr || 0 | percent }}</span>
                </span>&nbsp;
              </span>
              <span class="fw-bold" [class.text-primary]="vault.apy > vault.pairStat?.farmApr">
                {{vault.apy | percent}}</span>
            </div>
            <div class="fs-6 mt-2">TVL</div>
            <div class="fs-5">{{vault.pairStat?.tvl || 0 | unit: '1.0-2' }} UST</div>
          </div>
          <div class="col-12 col-sm-6 col-md-4">
            <div class="fs-6 mt-2">{{ vault.symbol }} Balance</div>
            <div class="fs-5">{{info.tokenBalances[vault.assetToken] || '0' | unit: '1.0-2' }}
              <span class="small text-muted" *ngIf="+info.tokenBalances[vault.assetToken]">
                &nbsp;(${{ info.tokenBalances[vault.assetToken] || '0' | balance: info.poolResponses[vault.assetToken] |
                unit: '1.0-2' }})</span>
            </div>
            <div class="fs-6 mt-2">LP Deposited</div>
            <div class="fs-5">{{ info.rewardInfos[vault.assetToken]?.bond_amount || '0' | unit: '1.0-2'}}
              <i class="fas fa-info-circle info-icon" [mdbTooltip]="info.rewardInfos[vault.assetToken] | rewardInfo"
                *ngIf="+info.rewardInfos[vault.assetToken]?.bond_amount"></i>
              <span class="small text-muted" *ngIf="+info.rewardInfos[vault.assetToken]?.bond_amount">
                &nbsp;(${{ info.rewardInfos[vault.assetToken]?.bond_amount || '0' | lpBalance:
                info.poolResponses[vault.assetToken] |
                unit: '1.0-2' }})</span>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-md-4">
            <div class="fs-6 mt-2">Staked SPEC <i class="fas fa-info-circle info-icon"
                mdbTooltip="During platform launch SPEC reward will be locked and release 2% per day"
                *ngIf="height < info.specFarmConfig?.lock_end"></i></div>
            <div class="fs-5"><span *ngIf="+info.rewardInfos[vault.assetToken]?.bond_amount"
                class="fas fa-chevron-up animate-up text-success"></span>
              {{info.rewardInfos[vault.assetToken]?.pending_spec_reward || 0 | unit: '1.0-2'}}
              <span class="small text-muted" *ngIf="+info.rewardInfos[vault.assetToken]?.pending_spec_reward">
                &nbsp;(${{ info.rewardInfos[vault.assetToken]?.pending_spec_reward || '0' | balance:
                info.poolResponses[terrajs.settings.specToken] |
                unit: '1.0-2' }})</span>
            </div>
            <div *ngIf="vault.poolInfo.farm !== 'Spectrum'">
              <div class="fs-6 mt-2">
                Staked <span *ngIf="vault.poolInfo.farm === 'Mirror'">MIR <i class="fas fa-info-circle info-icon"
                    mdbTooltip="MIR will be earned from auto-stake strategy. If you select auto-compound, LP will be earned."></i></span>
              </div>
              <div class="fs-5">{{info.rewardInfos[vault.assetToken]?.pending_farm_reward || 0 | unit: '1.0-2'}}
                <span class="small text-muted"
                  *ngIf="vault.poolInfo.farm === 'Mirror' && +info.rewardInfos[vault.assetToken]?.pending_farm_reward">
                  &nbsp;(${{ info.rewardInfos[vault.assetToken]?.pending_farm_reward || '0' | balance:
                  info.poolResponses[terrajs.settings.mirrorToken] |
                  unit: '1.0-2' }})</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="mt-3 bg-dark p-3 spec-form" mdbCollapse #belowSection="mdbCollapse">
      <mdb-tabs [fill]="true">
        <mdb-tab title="Deposit">
          <form class="needs-validation p-3" novalidate #formDeposit="ngForm">
            <div class="small">
              Need more {{ vault.symbol }}? <a [href]="vault.symbol | url:'trade'" target="_blank">Buy</a><span
                *ngIf="vault.symbol.startsWith('m')">
                or <a [href]="vault.symbol | url:'mint'" target="_blank">Borrow</a></span> {{ vault.symbol }} to farm
              with
            </div>
            <div class="text-end small mt-3 text-muted">
              <span>Balance: {{ info.tokenBalances[vault.assetToken] | unit }} {{ vault.symbol }}</span>
            </div>
            <div class="input-group">
              <span class="input-group-text">{{ vault.symbol }}</span>
              <input type="number" class="form-control fix-height-use-with-button" name="amountSPEC"
                [(ngModel)]="depositAmt" [min]="0.000001" [max]="+info.tokenBalances[vault.assetToken] / UNIT"
                [step]="0.000001" required #depositAmtCtl="ngModel" [pattern]="'^[0-9]+(.[0-9]{0,6})?$'"
                [class.is-invalid]="(formDeposit.submitted || depositAmtCtl.touched) && depositAmtCtl.invalid"
                (ngModelChange)="depositChanged()" />
              <button class="btn btn-outline-primary last" type="button" (click)="setMaxDeposit()">
                Max
              </button>
            </div>
            <span class="invalid-feedback-custom" *ngIf="depositAmt > +info.tokenBalances[vault.assetToken] / UNIT">
              Amount must be between 0 and {{info.tokenBalances[vault.assetToken] | unit }}
            </span>
            <span class="invalid-feedback-custom" *ngIf="depositAmtCtl.errors?.pattern">
              Amount must be within 6 decimal points
            </span>
            <div class="mt-3 icon-between-inputs"><i class="fas fa-plus fa-lg"></i></div>
            <div class="text-end small mt-1 text-muted">
              <span>Balance: {{ info.userUstAmount | number }} UST</span>
            </div>
            <div class="input-group">
              <span class="input-group-text igt-fixwidth">UST</span>
              <input type="number" class="form-control" name="amountUST" [(ngModel)]="amountUST"
                aria-describedby="USTLabel" #inputUst [min]="0.000001" [max]="+info.userUstAmount" [step]="0.000001"
                required #amountUSTCtl="ngModel" [disabled]="true"
                [class.is-invalid]="(formDeposit.submitted || amountUSTCtl.touched) && amountUSTCtl.invalid" />
            </div>
            <div class="mt-3 pool-info" *ngIf="amountUST" @fade>
              <div class="row">
                <div class="col">Terraswap Price</div>
                <div class="col text-end">{{info.poolResponses[vault.assetToken] | price | number }} UST</div>
              </div>
              <div class="row">
                <div class="col">LP from TX</div>
                <div class="col text-end">{{lpFromTx | number }} LP</div>
              </div>
            </div>
            <div class="mt-3" *ngIf="vault.poolInfo.auto_compound">
              <span class="btn-group">
                <button type="button" class="btn"
                  [ngClass]="depositType === 'compound' ? 'btn-primary': 'btn-outline-primary'"
                  (click)="depositType = 'compound'">Auto Compound</button>
                <button type="button" class="btn"
                  [ngClass]="depositType === 'stake' ? 'btn-primary': 'btn-outline-primary'"
                  (click)="depositType = 'stake'">Auto Stake</button>
              </span>
              <div class="invalid-feedback-custom" *ngIf="!depositType && formDeposit.submitted">
                Please select auto-farm mode
              </div>
              <div class="mt-3">
                <span class="side-note" *ngIf="depositType === 'compound'">With auto compound, your reward will be
                  automatically sold and provide to pool to earn even more reward.</span>
                <span class="side-note" *ngIf="depositType === 'stake'">When auto stake, your reward will be
                  automatically staked to gov to earn from gov income.</span>
              </div>
            </div>
            <div class="mt-3" *ngIf="depositType || !vault.poolInfo.auto_compound" @fade>
              <div *ngIf="depositType === 'compound'">
                <div class="row">
                  <div class="col">Pool APR from {{ vault.poolInfo.farm }}</div>
                  <div class="col text-end">{{vault.pairStat?.poolApr || 0 | percent }}</div>
                </div>
                <div class="row">
                  <div class="col">Pool APY from auto compound</div>
                  <div class="col text-end">{{vault.pairStat?.poolApy || 0 | percent }}</div>
                </div>
                <div class="row">
                  <div class="col">SPEC Reward</div>
                  <div class="col text-end">{{vault.specApy | percent }}</div>
                </div>
                <div class="row">
                  <div class="col">Total APY</div>
                  <div class="col text-end">{{vault.compoundApy | percent }}</div>
                </div>
              </div>

              <div *ngIf="depositType === 'stake' || !vault.poolInfo.auto_compound">
                <div class="row">
                  <div class="col">Pool APR from {{ vault.poolInfo.farm }}</div>
                  <div class="col text-end">{{vault.pairStat?.poolApr || 0 | percent }}</div>
                </div>
                <div class="row">
                  <div class="col">Pool APY from auto stake</div>
                  <div class="col text-end">{{vault.farmApy | percent }}</div>
                </div>
                <div class="row">
                  <div class="col">SPEC Reward</div>
                  <div class="col text-end">{{vault.specApy | percent }}</div>
                </div>
                <div class="row">
                  <div class="col">Total APY</div>
                  <div class="col text-end">{{vault.stakeApy | percent }}</div>
                </div>
              </div>
            </div>
            <div class="d-grid mt-3">
              <button type="submit" class="btn btn-primary" (click)="doDeposit()"
                [disabled]="depositAmtCtl.invalid">Deposit</button>
              <div class="text-end small fee-remark text-muted" *ngIf="vault.poolInfo.farm !== 'Spectrum'">
                <a href="https://spectrum-protocol.gitbook.io/spectrum-protocol/protocol/fees" target="_blank">
                  * fees applied
                </a>
              </div>
            </div>
          </form>
        </mdb-tab>
        <mdb-tab title="Withdraw">
          <form class="needs-validation p-3" novalidate #formWithdraw="ngForm">
            <div class="text-end small mt-3 text-muted">
              <span>Deposited: {{ info.rewardInfos[vault.assetToken]?.bond_amount || 0 | unit }} {{
                vault.symbol }}-UST LP</span>
            </div>
            <div class="input-group">
              <span class="input-group-text">{{ vault.symbol }}-UST LP</span>
              <input type="number" class="form-control fix-height-use-with-button" name="amountSPEC"
                [(ngModel)]="withdrawAmt" [min]="0.000001"
                [max]="+info.rewardInfos[vault.assetToken]?.bond_amount / UNIT" [step]="0.000001" required
                #withdrawAmtCtl="ngModel" [pattern]="'^[0-9]+(.[0-9]{0,6})?$'"
                [class.is-invalid]="(formWithdraw.submitted || withdrawAmtCtl.touched) && withdrawAmtCtl.invalid" />
              <button class="btn btn-outline-primary last" type="button" (click)="setMaxWithdrawLP()">
                Max
              </button>
            </div>
            <span class="invalid-feedback-custom"
              *ngIf="withdrawAmt > +info.rewardInfos[vault.assetToken]?.bond_amount / UNIT">Amount
              must
              be between 0 and {{info.rewardInfos[vault.assetToken]?.bond_amount | unit }}
            </span>
            <span class="invalid-feedback-custom" *ngIf="depositAmtCtl.errors?.pattern">
              Amount must be within 6 decimal points
            </span>
            <div *ngIf="withdrawAmt" class="mt-3">
              <div>
                Receive
              </div>
              <div>
                {{ withdrawAmt | lpSplit: info.poolResponses[vault.assetToken]: vault.symbol }}
              </div>
            </div>
            <div class="d-grid mt-3">
              <button type="submit" class="btn btn-primary" (click)="doWithdraw()"
                [disabled]="withdrawAmtCtl.invalid">Withdraw</button>
            </div>
          </form>
        </mdb-tab>
        <mdb-tab title="Unstake gov tokens">
          <div class="small mt-6">
            <span *ngIf="+info.rewardInfos[vault.assetToken]?.locked_spec_reward">
              To prevent token dump on platform launch, SPEC token rewards will be locked and released gradually over 50
              days.
            </span>
            All your rewards are automatically staked in gov vaults to earn gov income.
          </div>
          <div class="row mt-3">
            <div class="col">Staked SPEC</div>
            <div class="col text-end">
              {{info.rewardInfos[vault.assetToken]?.pending_spec_reward || 0 | unit }}</div>
          </div>
          <div *ngIf="+info.rewardInfos[vault.assetToken]?.locked_spec_reward">
            <div class="row">
              <div class="col">Locked SPEC</div>
              <div class="col text-end">
                {{info.rewardInfos[vault.assetToken]?.locked_spec_reward | unit }}</div>
            </div>
            <div class="row">
              <div class="col">Unlocking progress
                <i class="fas fa-info-circle info-icon"
                  [mdbTooltip]="'100% unlocked on ' + (info.specFarmConfig.lock_end | toDate | date) + ' (' + (info.specFarmConfig.lock_end | toDate | timeago) + ')'"></i>
              </div>
              <div class="col text-end">
                {{ 1 - +info.rewardInfos[vault.assetToken]?.locked_spec_share /
                +info.rewardInfos[vault.assetToken]?.accum_spec_share | percent }}</div>
            </div>
          </div>
          <div class="row" *ngIf="vault.poolInfo.farm !== 'Spectrum'">
            <div class="col">Staked <span *ngIf="vault.poolInfo.farm === 'Mirror'">MIR</span></div>
            <div class="col text-end">
              {{info.rewardInfos[vault.assetToken]?.pending_farm_reward || 0 | unit }}</div>
          </div>
          <div class="d-grid mt-3">
            <button type="submit" class="btn btn-primary" (click)="doClaimReward()">Unstake rewards</button>
            <button type="submit" class="btn btn-primary mt-2" (click)="doClaimReward(true)"
              *ngIf="vault.poolInfo.farm === 'Mirror'">Unstake all rewards from {{ vault.poolInfo.farm }}</button>
          </div>
        </mdb-tab>
      </mdb-tabs>
    </div>
  </div>
</div>