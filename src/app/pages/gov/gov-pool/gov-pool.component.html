<div [ngClass]="{'border border-primary' : +detail.userBalance > 0}" class="card hover-shadow">
  <span *ngIf="+detail.userBalance > 0" class="badge bg-primary position-absolute badge-staked">Staked</span>
  <div class="card-body" style="cursor: pointer;" (click)="toggleExpanded()" aria-controls="belowSection"
    aria-expanded="false">
    <div class="d-flex align-items-center gap-2 pb-3 border-bottom mb-3">
      <img class="spec-logo" src="/assets/logo.png" class="logo" />
      <div class="h5 mb-0">
        {{ detail.days === 0 ? 'No Lock' : detail.days + '-Day Locked' }}
      </div>
    </div>

    <div class="d-flex gap-2 ">
      <div class="flex-grow-1 d-flex flex-column gap-2">
        <div>
          <div>
            Total Staked
          </div>
          <app-digit [value]="+detail.balance"></app-digit> SPEC
        </div>
        <div>
          <div>
            Your Staked
            <small *ngIf="+detail.userBalance >0 && detail.unlockAt" class="text-primary">
              <i [ngClass]="isWithdrawLocked ? 'fa-lock' : 'fa-unlock'" class="fas"></i> Unlock{{!isWithdrawLocked ? "ed" : ""}} {{ detail.unlockAt |
              timeago }}
            </small>
          </div>
          <div>
            <app-digit [value]="+detail.userBalance"></app-digit> SPEC
          </div>
        </div>
      </div>
      <div class="text-end">
        <div class="text-primary fs-2 lh-1">{{ detail.apr | percent }}</div>
        <div class="text-primary">
          APR
        </div>
        <div class="text lh-sm">
          {{ detail.apr / 365 | percent }} Daily Rate
          <i class="fas fa-info-circle info-icon" mdbTooltip="SPEC staking return from vault fee"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="card-body pt-0" #belowSection="mdbCollapse" mdbCollapse>
    <div class="p-3 bg-dark rounded">
      <mdb-tabs [justified]="true" (activeTabChange)="onActiveTabChange()">
        <mdb-tab title="Deposit">
          <div class="d-grid gap-3">
            <div>
              <div class="small text-muted text-end">
                Balance: {{ walletBalance | number }} SPEC
              </div>
              <div class="input-group">
                <span class="input-group-text">SPEC</span>
                <input type="number" class="form-control" [class.is-invalid]="depositAmountModel.invalid"
                  placeholder="0.000000" [pattern]="'^[0-9]+(.[0-9]{0,6})?$'" [max]="+walletBalance"
                  [(ngModel)]="depositAmount" #depositAmountModel="ngModel" (change)="calculateDepositUnlock()">
                <button class="btn btn-outline-primary"
                  (click)="depositAmount = +walletBalance; calculateDepositUnlock()">Max</button>
                <div *ngIf="depositAmountModel.errors?.max; then exceededBalanceError"></div>
                <div *ngIf="depositAmountModel.errors?.pattern; then maxDecimalPlacesError"></div>
              </div>
            </div>
            <div *ngIf="detail.days > 0" class="d-flex flex-wrap small text-muted">
              <div class="flex-grow-1">Estimated Unlock Time:&nbsp;</div>
              <div>{{ estimatedDepositUnlock ? (estimatedDepositUnlock | date:'medium') : '-' }}</div>
            </div>
            <button type="button" class="btn btn-lg btn-primary" (click)="submitDeposit()"
              [disabled]="depositAmount <= 0 || depositAmountModel.invalid">
              Deposit
            </button>
          </div>
        </mdb-tab>

        <mdb-tab [disabled]="!detail.moveOptions.length" title="Move">
          <div class="d-grid gap-3">
            <div *ngIf="detail.moveOptions.length > 1">
              <div class="small">Lock Duration (Days)</div>
              <div class="btn-group w-100">
                <button *ngFor="let option of detail.moveOptions" type="button" class="btn btn-lg"
                  [class.btn-secondary]="moveDays === option.days"
                  [class.btn-outline-secondary]="moveDays !== option.days"
                  (click)="moveDays = option.days; calculateMoveUnlock()">
                  {{ option.days }}
                </button>
              </div>
            </div>
            <div>
              <div class="small text-muted text-end">
                Balance: {{ detail.userBalance | number }} SPEC
              </div>
              <div class="input-group">
                <span class="input-group-text">SPEC</span>
                <input type="number" class="form-control" [class.is-invalid]="moveAmountModel.invalid"
                  placeholder="0.000000" [pattern]="'^[0-9]+(.[0-9]{0,6})?$'" [max]="+detail.userBalance"
                  [(ngModel)]="moveAmount" #moveAmountModel="ngModel" (change)="calculateMoveUnlock()">
                <button class="btn btn-outline-primary"
                  (click)="moveAmount = +detail.userBalance; calculateMoveUnlock()">Max</button>
                <div *ngIf="moveAmountModel.errors?.max; then exceededBalanceError"></div>
                <div *ngIf="moveAmountModel.errors?.pattern; then maxDecimalPlacesError"></div>
              </div>
            </div>
            <div *ngIf="detail.moveOptions.length === 1" class="d-flex flex-wrap small text-muted">
              <div class="flex-grow-1">Lock Duration:&nbsp;</div>
              <div>{{ moveDays }} Day{{moveDays > 1 ? "s" : ""}}</div>
            </div>
            <div class="d-flex flex-wrap small text-muted">
              <div class="flex-grow-1">Estimated Unlock Time:&nbsp;</div>
              <div>{{ estimatedMoveUnlock ? (estimatedMoveUnlock | date:'medium') : '-' }}</div>
            </div>
            <button type="button" class="btn btn-lg btn-primary" (click)="submitMove()"
              [disabled]="moveAmount <= 0 || moveAmountModel.invalid">
              Move
            </button>
          </div>
        </mdb-tab>

        <mdb-tab title="Withdraw">
          <div class="d-grid gap-3">
            <div>
              <div class="small text-muted text-end">
                Balance: {{ detail.userAvailableBalance | number }} SPEC <span *ngIf="detail.userBalance !== detail.userAvailableBalance">
                  (Locked: {{+detail.userBalance - +detail.userAvailableBalance | number}} SPEC from voting)
                </span>
              </div>
              <div class="input-group">
                <span class="input-group-text">SPEC</span>
                <input type="number" class="form-control" [class.is-invalid]="withdrawAmountModel.invalid"
                  placeholder="0.000000" [pattern]="'^[0-9]+(.[0-9]{0,6})?$'" [max]="+detail.userAvailableBalance"
                  [(ngModel)]="withdrawAmount" #withdrawAmountModel="ngModel" [disabled]="isWithdrawLocked">
                <button class="btn btn-outline-primary" (click)="withdrawAmount = +detail.userAvailableBalance"
                  [disabled]="isWithdrawLocked">
                  Max
                </button>
                <div *ngIf="withdrawAmountModel.errors?.max; then exceededBalanceError"></div>
                <div *ngIf="withdrawAmountModel.errors?.pattern; then maxDecimalPlacesError"></div>
              </div>
            </div>
            <button type="button" class="btn btn-lg btn-primary" (click)="submitWithdraw()"
              [disabled]="isWithdrawLocked || withdrawAmount <= 0 || withdrawAmountModel.invalid">
              {{ isWithdrawLocked ? 'Locked until ' + (detail.unlockAt | date:'medium') : 'Withdraw' }}
            </button>
          </div>
        </mdb-tab>
      </mdb-tabs>
    </div>
  </div>
</div>

<ng-template #exceededBalanceError>
  <div class="invalid-feedback">
    Amount must not be greater than the balance
  </div>
</ng-template>

<ng-template #maxDecimalPlacesError>
  <div class="invalid-feedback">
    Amount must be within 6 decimal points
  </div>
</ng-template>